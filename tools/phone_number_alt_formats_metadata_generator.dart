import 'dart:convert';
import 'dart:io';

import 'package:dlibphonenumber/generated/classes/phone_metadata/phonemetadata.pb.dart';
import 'package:xml/xml.dart';

import 'copyright_notice.dart';
import 'file_writer.dart';
import 'phone_metadata_parser.dart';

class PhoneNumberAltFormatsMetadataGenerator extends FileWriter with PhoneMetadataParser {
  PhoneNumberAltFormatsMetadataGenerator(super.args);

  final List<String> _importStatements = ["import 'package:dlibphonenumber/metadata_map_loader.dart';"];
  final StringBuffer _territoriesMapsBuffer = StringBuffer();

  String start() {
    final File file = File(args.inputFilePath);
    final XmlDocument document = XmlDocument.parse(file.readAsStringSync());
    final Iterable<XmlElement> nodes = document.findAllElements('territory');

    for (XmlElement node in nodes) {
      final Map<String, dynamic> metadata = parseTerritory(node);
      final PhoneMetadata phoneMetadata = PhoneMetadata()..mergeFromProto3Json(metadata);
      _buildTerritoriesMap(phoneMetadata);
      _savePhoneMetadata(phoneMetadata);
    }

    _savePhoneNumberMetadataMap();
    return '${args.metadataType} Alternate Formats metadata generated at ${args.outputDirectory}';
  }

  String _getImportPath(String id) {
    return "import 'phone_number_alt/$id.dart';";
  }

  /// Mark: build supported territories imports and JSON data.
  void _buildTerritoriesMap(PhoneMetadata phoneMetadata) {
    String id = '${phoneMetadata.countryCode}';
    _importStatements.add(_getImportPath(id));
    _territoriesMapsBuffer.write("'$id': get$id(),");
  }

  /// Mark: save the metadata for each country in a JSON format
  void _savePhoneMetadata(PhoneMetadata phoneMetadata) {
    String id = '${phoneMetadata.countryCode}';
    String ignoreStatements = '// ignore_for_file: file_names\n';
    String comments = '// This file is automatically generated from [${args.inputFilePath}].\n';
    String content = jsonEncode(phoneMetadata.toProto3Json()).replaceAll(r'$', r'\$');
    String fileOverview = '/// Phone Number Alt-Format JSON data for $id\n';
    saveAsMapObject('$ignoreStatements$comments$fileOverview', id, content);
  }

  /// Mark: create a convenient map of all the supported countries
  /// with their JSON data
  void _savePhoneNumberMetadataMap() {
    StringBuffer stringBuffer = StringBuffer();
    String copyright = CopyrightNotice(2009, DateTime.now().year).toString();
    String fileOverview = ''
        '///\n'
        '/// [fileoverview]\n'
        '/// This file is automatically generated from [${args.inputFilePath}].\n'
        '/// Please do not modify it directly.\n'
        '///\n\n';

    String phoneNumberMetadataMap = ''
        ' class PhoneNumberAltFormatsMetadataMap extends MetadataMapLoader {\n'
        '   const PhoneNumberAltFormatsMetadataMap();'
        '\n\n'
        '   @override\n'
        '   Map<String, Object?>? getTerritory(String code) {\n'
        '     return _territories[code];\n'
        '   }'
        '\n\n'
        '   Map<String, Map<String, Object?>> get _territories {\n'
        '     return {${_territoriesMapsBuffer.toString()}};\n'
        '   }\n'
        ' }\n';

    stringBuffer
      ..write(copyright)
      ..write(_importStatements.join())
      ..write(fileOverview)
      ..write(phoneNumberMetadataMap);

    return saveAsStringToSubDirectory(
      'phone_number_alt_formats_metadata_map',
      stringBuffer.toString(),
    );
  }
}
